<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Credential Attacks - Ultimate IAM Security Guide</title>
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <div class="page-wrapper">
    <nav class="sidebar">
      <div class="sidebar-header">
        <a href="index.html" class="sidebar-logo">
          <div class="sidebar-logo-icon">ğŸ”</div>
          <div class="sidebar-logo-text">IAM <span>Guide</span></div>
        </a>
      </div>
    </nav>
    <main class="main-content">
      <div class="content-wrapper">
        <article class="content-main">
          <div class="badge badge-l3">L3 Advanced</div>
          <h1>Credential Attacks & Defense</h1>
          
          <div class="overview-box">
            <h3>ğŸ¯ What This Page Covers</h3>
            <p>Understanding how attackers steal and abuse credentials is essential for defense. Covers password spraying, credential stuffing, phishing, token theft, and how to detect/prevent each.</p>
          </div>

          <h2 id="attack-landscape">Credential Attack Landscape</h2>

          <div class="table-wrapper">
            <table>
              <thead><tr><th>Attack Type</th><th>How It Works</th><th>Detection</th><th>Prevention</th></tr></thead>
              <tbody>
                <tr>
                  <td><strong>Password Spraying</strong></td>
                  <td>Try common passwords against many accounts</td>
                  <td>Multiple failed logins across accounts</td>
                  <td>MFA, smart lockout, banned passwords</td>
                </tr>
                <tr>
                  <td><strong>Credential Stuffing</strong></td>
                  <td>Use breached credentials from other sites</td>
                  <td>Logins from unusual locations/devices</td>
                  <td>MFA, password monitoring, unique passwords</td>
                </tr>
                <tr>
                  <td><strong>Phishing</strong></td>
                  <td>Trick users into entering credentials</td>
                  <td>Suspicious sign-ins, user reports</td>
                  <td>MFA, security training, email filtering</td>
                </tr>
                <tr>
                  <td><strong>Token Theft</strong></td>
                  <td>Steal session tokens to bypass authentication</td>
                  <td>Impossible travel, session anomalies</td>
                  <td>CAE, token binding, short token lifetime</td>
                </tr>
                <tr>
                  <td><strong>Pass-the-Hash</strong></td>
                  <td>Use NTLM hash without knowing password</td>
                  <td>NTLM auth from unexpected sources</td>
                  <td>Credential Guard, disable NTLM</td>
                </tr>
              </tbody>
            </table>
          </div>

          <h2 id="password-spraying">Password Spraying Deep Dive</h2>

          <div class="flow-diagram">
            <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PASSWORD SPRAYING ATTACK                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                          â”‚
â”‚   ATTACKER'S APPROACH:                                                                  â”‚
â”‚   Instead of: 1 account, 1000 password guesses (triggers lockout)                      â”‚
â”‚   Do: 1000 accounts, 1 password guess each (avoids lockout)                            â”‚
â”‚                                                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Try "Summer2024!" against:                                                      â”‚   â”‚
â”‚   â”‚                                                                                  â”‚   â”‚
â”‚   â”‚  user001@company.com â”€â”€â”€ âŒ Failed                                              â”‚   â”‚
â”‚   â”‚  user002@company.com â”€â”€â”€ âŒ Failed                                              â”‚   â”‚
â”‚   â”‚  user003@company.com â”€â”€â”€ âŒ Failed                                              â”‚   â”‚
â”‚   â”‚  ...                                                                             â”‚   â”‚
â”‚   â”‚  user847@company.com â”€â”€â”€ âœ… SUCCESS! (user has weak password)                   â”‚   â”‚
â”‚   â”‚  ...                                                                             â”‚   â”‚
â”‚   â”‚  user999@company.com â”€â”€â”€ âŒ Failed                                              â”‚   â”‚
â”‚   â”‚                                                                                  â”‚   â”‚
â”‚   â”‚  Wait 30 minutes... try next password "Company123!"                             â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                          â”‚
â”‚   COMMON PASSWORDS TRIED:                                                               â”‚
â”‚   â€¢ Season + Year: Summer2024!, Winter2023!, Spring2024!                               â”‚
â”‚   â€¢ Company + Numbers: Acme123!, Company2024!                                          â”‚
â”‚   â€¢ Welcome variations: Welcome1!, Welcome123!                                          â”‚
â”‚   â€¢ Password variations: Password1!, P@ssw0rd!                                         â”‚
â”‚                                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </pre>
          </div>

          <h3>Detection</h3>
          <div class="code-block">
            <div class="code-header"><span class="code-language">KQL: Detect Password Spraying</span></div>
            <pre><code>// Azure AD Sign-in Logs - Password Spray Detection
SigninLogs
| where TimeGenerated > ago(1h)
| where ResultType == "50126"  // Invalid username or password
| summarize 
    FailedAttempts = count(),
    DistinctUsers = dcount(UserPrincipalName),
    Users = make_set(UserPrincipalName, 100)
  by IPAddress, bin(TimeGenerated, 10m)
| where DistinctUsers > 10  // Same IP, many different users
| order by DistinctUsers desc</code></pre>
          </div>

          <h3>Prevention</h3>
          <ul>
            <li><strong>MFA:</strong> Even if password guessed, attacker can't complete login</li>
            <li><strong>Smart Lockout:</strong> Entra ID learns legitimate vs attack traffic</li>
            <li><strong>Banned Passwords:</strong> Block common/seasonal passwords</li>
            <li><strong>Conditional Access:</strong> Block suspicious locations</li>
          </ul>

          <h2 id="phishing">Phishing & AiTM Attacks</h2>

          <div class="flow-diagram">
            <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ADVERSARY-IN-THE-MIDDLE (AiTM) PHISHING                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                          â”‚
â”‚   USER                    ATTACKER PROXY                REAL MICROSOFT                  â”‚
â”‚     â”‚                          â”‚                             â”‚                          â”‚
â”‚     â”‚  1. Clicks phishing link â”‚                             â”‚                          â”‚
â”‚     â”‚  (looks like login.microsoft.com)                      â”‚                          â”‚
â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                             â”‚                          â”‚
â”‚     â”‚                          â”‚  2. Proxies to real site    â”‚                          â”‚
â”‚     â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                          â”‚
â”‚     â”‚  3. Real login page      â”‚                             â”‚                          â”‚
â”‚     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
â”‚     â”‚                          â”‚                             â”‚                          â”‚
â”‚     â”‚  4. User enters creds    â”‚                             â”‚                          â”‚
â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  5. Forward creds           â”‚                          â”‚
â”‚     â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                          â”‚
â”‚     â”‚                          â”‚                             â”‚                          â”‚
â”‚     â”‚  6. MFA prompt           â”‚                             â”‚                          â”‚
â”‚     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
â”‚     â”‚                          â”‚                             â”‚                          â”‚
â”‚     â”‚  7. User completes MFA   â”‚  8. Forward MFA             â”‚                          â”‚
â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                          â”‚
â”‚     â”‚                          â”‚                             â”‚                          â”‚
â”‚     â”‚                          â”‚  9. Session cookie issued   â”‚                          â”‚
â”‚     â”‚                          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
â”‚     â”‚                          â”‚                             â”‚                          â”‚
â”‚     â”‚                          â”‚  ğŸ”´ ATTACKER STEALS COOKIE  â”‚                          â”‚
â”‚     â”‚                          â”‚  Uses cookie from their     â”‚                          â”‚
â”‚     â”‚                          â”‚  machine = FULL ACCESS      â”‚                          â”‚
â”‚     â”‚                          â”‚                             â”‚                          â”‚
â”‚   KEY: This bypasses MFA! Attacker gets the session token after MFA is complete.       â”‚
â”‚                                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </pre>
          </div>

          <h3>Defense Against AiTM</h3>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Control</th><th>How It Helps</th></tr></thead>
              <tbody>
                <tr>
                  <td><strong>Phishing-Resistant MFA</strong></td>
                  <td>FIDO2 keys, Windows Hello - can't be proxied</td>
                </tr>
                <tr>
                  <td><strong>Conditional Access: Require Compliant Device</strong></td>
                  <td>Attacker's machine won't be compliant</td>
                </tr>
                <tr>
                  <td><strong>Token Protection (Preview)</strong></td>
                  <td>Binds tokens to specific device</td>
                </tr>
                <tr>
                  <td><strong>CAE (Continuous Access Evaluation)</strong></td>
                  <td>Faster revocation when risk detected</td>
                </tr>
              </tbody>
            </table>
          </div>

          <h2 id="token-theft">Token Theft</h2>
          <p>Attackers steal tokens from browser storage, memory, or via malware to bypass authentication entirely.</p>

          <div class="code-block">
            <div class="code-header"><span class="code-language">Token Theft Scenarios</span></div>
            <pre><code>1. BROWSER TOKEN THEFT
   Malware extracts tokens from browser storage/cookies
   Defense: Token binding, short lifetimes, CAE

2. MEMORY EXTRACTION  
   Tools like Mimikatz dump tokens from memory
   Defense: Credential Guard, protected processes

3. MAN-IN-THE-BROWSER
   Browser extension intercepts tokens
   Defense: Browser security, endpoint protection

4. ADVERSARY-IN-THE-MIDDLE
   Proxy steals session cookies during "login"
   Defense: Phishing-resistant MFA, device compliance</code></pre>
          </div>

          <h2 id="detection-hunting">Detection & Hunting</h2>

          <div class="code-block">
            <div class="code-header"><span class="code-language">KQL: Suspicious Sign-in Detection</span></div>
            <pre><code>// Impossible Travel - Same user from distant locations
SigninLogs
| where TimeGenerated > ago(24h)
| where ResultType == 0  // Successful logins
| project TimeGenerated, UserPrincipalName, IPAddress, Location, DeviceDetail
| order by UserPrincipalName, TimeGenerated
| serialize
| extend PrevLocation = prev(Location), PrevTime = prev(TimeGenerated)
| where UserPrincipalName == prev(UserPrincipalName)
| extend TimeDiff = datetime_diff('hour', TimeGenerated, PrevTime)
| where Location != PrevLocation and TimeDiff < 2
// Two different countries within 2 hours = impossible

// Token Replay Detection - Unusual token reuse patterns
SigninLogs
| where TimeGenerated > ago(1h)
| where TokenIssuerType == "AzureAD"
| summarize 
    IPAddresses = dcount(IPAddress),
    Locations = dcount(Location),
    Devices = dcount(DeviceDetail.deviceId)
  by UserPrincipalName
| where IPAddresses > 3 or Locations > 2
// Same user token used from multiple IPs/locations</code></pre>
          </div>

          <h2 id="interview-tips">Interview Tips</h2>
          <div class="callout interview">
            <div class="callout-content">
              <div class="callout-title">ğŸ’¡ Key Interview Points</div>
              <ul>
                <li><strong>Password spraying:</strong> Few passwords, many accounts (avoids lockout)</li>
                <li><strong>AiTM phishing:</strong> Bypasses MFA by stealing session token</li>
                <li><strong>Defense in depth:</strong> MFA alone isn't enough, need device compliance + phishing-resistant MFA</li>
                <li><strong>FIDO2/Windows Hello:</strong> Phishing-resistant because credential is bound to legitimate site</li>
                <li><strong>Detection:</strong> Look for impossible travel, token reuse, unusual locations</li>
                <li><strong>CAE:</strong> Enables faster token revocation when risk detected</li>
              </ul>
            </div>
          </div>

          <nav class="page-nav">
            <a href="11-1-identity-threat-landscape.html" class="page-nav-link prev">
              <span class="page-nav-label">â† Previous</span>
              <span class="page-nav-title">Identity Threat Landscape</span>
            </a>
            <a href="11-3-token-session-attacks.html" class="page-nav-link next">
              <span class="page-nav-label">Next â†’</span>
              <span class="page-nav-title">Token & Session Attacks</span>
            </a>
          </nav>
        </article>
      </div>
    </main>
  </div>
  <script src="main.js"></script>
</body>
</html>
