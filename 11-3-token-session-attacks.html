<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Token & Session Attacks - Ultimate IAM Security Guide</title>
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <div class="page-wrapper">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" aria-label="Toggle navigation">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
    <nav class="sidebar">
      <div class="sidebar-header">
        <a href="index.html" class="sidebar-logo">
          <div class="sidebar-logo-icon">ğŸ”</div>
          <div class="sidebar-logo-text">IAM <span>Guide</span></div>
        </a>
      </div>
      <!-- Navigation generated by JavaScript -->
    </nav>
    <main class="main-content">
      <div class="content-wrapper">
        <article class="content-main">
          <div class="badge badge-l3">L3 Expert</div>
          <h1>Token & Session Attacks</h1>
          
          <div class="overview-box">
            <h3>ğŸ¯ What This Page Covers</h3>
            <p>Modern attacks focus on stealing tokens and sessions rather than passwords. This covers token theft, session hijacking, AiTM attacks, and defenses.</p>
          </div>

          <h2 id="aitm">Adversary-in-the-Middle (AiTM)</h2>
          <div class="flow-diagram"><pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AiTM PHISHING ATTACK                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                          â”‚
â”‚   VICTIM                    ATTACKER PROXY                    REAL IdP                  â”‚
â”‚     â”‚                           â”‚                                â”‚                      â”‚
â”‚     â”‚  1. Clicks phishing link  â”‚                                â”‚                      â”‚
â”‚     â”‚   (looks like real login) â”‚                                â”‚                      â”‚
â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                â”‚                      â”‚
â”‚     â”‚                           â”‚  2. Forwards to real IdP       â”‚                      â”‚
â”‚     â”‚                           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
â”‚     â”‚                           â”‚                                â”‚                      â”‚
â”‚     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
â”‚     â”‚  3. Real login page       â”‚     (proxied)                  â”‚                      â”‚
â”‚     â”‚                           â”‚                                â”‚                      â”‚
â”‚     â”‚  4. User enters creds     â”‚                                â”‚                      â”‚
â”‚     â”‚     + completes MFA       â”‚                                â”‚                      â”‚
â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
â”‚     â”‚                           â”‚                                â”‚                      â”‚
â”‚     â”‚                           â”‚  5. Attacker captures          â”‚                      â”‚
â”‚     â”‚                           â”‚     SESSION TOKEN              â”‚                      â”‚
â”‚     â”‚                           â”‚     (MFA already passed!)      â”‚                      â”‚
â”‚     â”‚                           â”‚                                â”‚                      â”‚
â”‚                                                                                          â”‚
â”‚   KEY INSIGHT: MFA doesn't help because attacker steals the POST-MFA session token      â”‚
â”‚                                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre></div>

          <h2 id="token-types">Token Attack Targets</h2>
          <div class="table-wrapper"><table>
            <thead><tr><th>Token Type</th><th>Attack Method</th><th>Impact</th><th>Defense</th></tr></thead>
            <tbody>
              <tr><td><strong>Session Cookie</strong></td><td>AiTM, malware, XSS</td><td>Full account access</td><td>Token binding, CAE</td></tr>
              <tr><td><strong>Access Token</strong></td><td>Memory extraction, log exposure</td><td>API access until expiry</td><td>Short TTL, CAE</td></tr>
              <tr><td><strong>Refresh Token</strong></td><td>Malware, token theft</td><td>Long-term access</td><td>Token rotation, binding</td></tr>
              <tr><td><strong>PRT (Primary Refresh Token)</strong></td><td>Mimikatz, device compromise</td><td>SSO to all apps</td><td>Device compliance, TPM</td></tr>
            </tbody>
          </table></div>

          <h2 id="prt-attack">PRT Theft (Golden SAML equivalent for Entra)</h2>
          <div class="code-block"><div class="code-header"><span class="code-language">PRT Theft with Mimikatz</span></div><pre><code># PRT is stored in LSASS on Windows devices
# If attacker gets admin on device, they can extract it

# Using Mimikatz/AADInternals:
mimikatz # sekurlsa::cloudap

# Or AADInternals:
Get-AADIntUserPRTToken

# With the PRT, attacker can:
# - Get access tokens for any app the user has access to
# - Bypass MFA (PRT is post-MFA)
# - Access resources from any location

# Defense:
# - Credential Guard (protects PRT in VSM)
# - TPM-protected PRT
# - Device compliance policies</code></pre></div>

          <h2 id="defenses">Defenses</h2>
          <div class="table-wrapper"><table>
            <thead><tr><th>Defense</th><th>What It Does</th><th>Attacks Mitigated</th></tr></thead>
            <tbody>
              <tr><td><strong>Phishing-Resistant MFA</strong></td><td>FIDO2 keys bound to legitimate site</td><td>AiTM phishing</td></tr>
              <tr><td><strong>CAE (Continuous Access Eval)</strong></td><td>Real-time token revocation</td><td>Token replay after revocation</td></tr>
              <tr><td><strong>Token Binding</strong></td><td>Bind tokens to device/cert</td><td>Token theft from network</td></tr>
              <tr><td><strong>Device Compliance</strong></td><td>Require managed/compliant device</td><td>Access from attacker device</td></tr>
              <tr><td><strong>Credential Guard</strong></td><td>Protect creds in virtualized container</td><td>PRT theft from memory</td></tr>
            </tbody>
          </table></div>

          <h2 id="cae">Continuous Access Evaluation (CAE)</h2>
          <div class="code-block"><div class="code-header"><span class="code-language">CAE Events</span></div><pre><code># CAE enables near real-time token revocation

# Critical Events that trigger immediate re-evaluation:
- User account disabled
- User password changed/reset
- MFA registration changed
- Admin revokes refresh tokens
- User risk level changes to high
- Device becomes non-compliant

# Without CAE: Token valid until expiry (typically 1 hour)
# With CAE: Token revoked within minutes

# Enable CAE:
Conditional Access â†’ Session â†’ Customize continuous access evaluation
â†’ Disable Resilience defaults (strict mode)</code></pre></div>

          <h2 id="interview-tips">Interview Tips</h2>
          <div class="callout interview"><div class="callout-content"><div class="callout-title">ğŸ’¡ Key Interview Points</div>
            <ul>
              <li><strong>AiTM:</strong> Phishing proxy steals session tokens AFTER MFA</li>
              <li><strong>Defense:</strong> Phishing-resistant MFA (FIDO2) is the only real defense</li>
              <li><strong>PRT:</strong> Primary Refresh Token = SSO for all apps, high-value target</li>
              <li><strong>CAE:</strong> Continuous Access Evaluation enables fast token revocation</li>
              <li><strong>Token lifetime:</strong> Shorter is better, but impacts UX</li>
            </ul>
          </div></div>

          <nav class="page-nav">
            <a href="11-2-credential-attacks.html" class="page-nav-link prev"><span class="page-nav-label">â† Previous</span><span class="page-nav-title">Credential Attacks</span></a>
            <a href="11-4-privilege-escalation.html" class="page-nav-link next"><span class="page-nav-label">Next â†’</span><span class="page-nav-title">Privilege Escalation</span></a>
          </nav>
        </article>
      </div>
    </main>
  </div>
  <script src="main.js"></script>
</body>
</html>
